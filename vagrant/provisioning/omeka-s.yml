---

#############################################################################
##
##  Auto-Omeka-S
##  T McIntyre for UTS eResearch 2015
##
#############################################################################


- hosts: all
  user: vagrant
  sudo: yes

  tasks:
    - include_vars: group_vars/config.yml

#    - selinux: state=disabled    # permissive default seems ok


#############################################################################
##
##  Prep and dependencies
##
#############################################################################

    - hostname: name={{ hostname }}

    - name: update base OS packages
      action: yum name=* state=latest

    - name: check if EPEL repo is installed yet
      stat: path=/etc/yum.repos.d/epel.repo
      register: epel_repo_present

    - name: add EPEL repo
      command: rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      when: not epel_repo_present.stat.exists
      
    - name: check if webtastic repo is installed yet
      stat: path=/etc/yum.repos.d/webtatic.repo
      register: webtastic_repo_present
      
    - name: add Webtatic repo so we can have PHP 5.5
      command: rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
      when: not webtastic_repo_present.stat.exists

    - name: install useful tools
      action: yum name={{ item }} state=latest
      with_items:
        - wget
        - telnet
        - lynx
        - mlocate
        - lsof
        - git
        - ant
    
    - name: install apache
      yum: pkg=httpd state=latest
      register: httpdinstalled
      
    - lineinfile: dest=/etc/httpd/conf/httpd.conf line="NameVirtualHost *:80" state=present
      when: httpdinstalled|success
       
    - template: src=templates/25-omeka-s.conf.j2 dest=/etc/httpd/conf.d/25-omeka-s.conf owner=root group=wheel mode=0644
      when: httpdinstalled|success

    - name: install php & ancillaries
      action: yum name={{ item }} state=latest
      with_items:
        - php55w
#        - php-xml
#        - php-pear
#        - php-mysqli
        - php55w-mysqlnd
        - php55w-mbstring
        - php55w-xml

    - action: service name=httpd state=started enabled=yes

    - name: install mariadb
      action: yum name={{ item }} state=latest
      with_items:
        - mariadb-server
        - MySQL-python  # bindings for ansible modules to use
      register: mariadbinstalled
      
    - action: service name=mariadb state=started enabled=yes

#    - template: src=templates/my.cnf.j2 dest=/etc/my.cnf owner=root group=wheel mode=0644
#      when: mariadbinstalled|success
#      notify:
#      - restart mariadb-server

    - name: ImageMagick
      yum: pkg=ImageMagick state=latest



#############################################################################
##
##  Omeka core
##
#############################################################################


    - name: check if omeka core is present already
      stat: path=/var/www/html/omeka-{{ omeka_version }}/index.php
      register: omekacoreexists
      
 #   - debug: var=omekacoreexists.stat.exists
    
    - name: fetch omeka core
      get_url: url=https://github.com/omeka/omeka-s/archive/v{{ omeka_version }}.tar.gz dest=/tmp/omeka-s-{{ omeka_version }}.tar.gz
      register: omekacorearchivefetched
      when: not omekacoreexists.stat.exists
      
    - name: extract omeka core
      unarchive: src=/tmp/omeka-s-{{ omeka_version }}.tar.gz dest=/var/www/html/ creates=/var/www/html/omeka-s-{{ omeka_version }}/index.php copy=no
      register: omekacoreextracted
      when: omekacorearchivefetched|success

    - template: src=templates/database.ini.j2 dest=/var/www/html/omeka-s-{{ omeka_version }}/config/database.ini owner=root group=wheel mode=0644
    
    - command: /bin/chown -R apache:apache /var/www/html/omeka-s-{{ omeka_version }}/files/
      
    - mysql_db: name=omeka_db state=present
    - mysql_user: name=omeka password={{ db_password }} priv=omeka_db.*:ALL state=present

    - name: initialise install
      shell: ant init
      args:
        chdir: /var/www/html/omeka-s-{{ omeka_version }}/
        creates: build/composer.phar

